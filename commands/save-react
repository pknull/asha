#!/bin/bash
# /save-react - Experimental ReAct-enhanced save command

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ASHA_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_ROOT="$(dirname "$ASHA_DIR")"

# Change to project root
cd "$PROJECT_ROOT"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "Error: Python 3 is required for /save-react"
    exit 1
fi

# Check if current session exists
if [ ! -f "Memory/sessions/current-session.md" ]; then
    echo "No current session found. Nothing to save."
    exit 1
fi

# Run the Python ReAct analyzer directly
python3 << 'PYTHON_SCRIPT'
import os
import sys
import json
import subprocess
from pathlib import Path
from datetime import datetime

# Add asha tools to path
sys.path.insert(0, './asha/tools')

# Import our local ReAct analyzer
try:
    from local_react_save import LocalReActSave
except ImportError:
    print("Error: Could not import LocalReActSave. Make sure local_react_save.py exists in asha/tools/")
    sys.exit(1)

def get_current_session():
    """Get the current session file"""
    session_file = Path("Memory/sessions/current-session.md")
    if not session_file.exists():
        print("No current session found. Nothing to save.")
        return None
    return session_file

def run_react_analysis(session_file):
    """Run ReAct analysis on the session"""
    print("\nðŸ§  Running ReAct Analysis...")
    print("=" * 50)
    
    agent = LocalReActSave(str(session_file))
    report = agent.execute()
    
    return report

def display_recommendations(report):
    """Display the ReAct recommendations"""
    print("\nðŸ“Š ReAct Recommendations")
    print("=" * 50)
    
    # Analysis summary
    analysis = report.get('analysis', {})
    patterns_found = analysis.get('patterns_found', {})
    code_patterns = patterns_found.get('code_patterns', []) if patterns_found else []
    
    print(f"\nðŸ“ˆ Analysis Summary:")
    print(f"  â€¢ Patterns found: {len(code_patterns)}")
    print(f"  â€¢ Similar patterns in memory: {analysis.get('similar_patterns', 0)}")
    print(f"  â€¢ Redundancy: {analysis.get('redundancy_percentage', 0):.1f}%")
    print(f"  â€¢ Novel insights: {len(analysis.get('novel_insights', []))}")
    
    # Recommendations
    recs = report.get('recommendations', {})
    
    if recs.get('memory_updates'):
        print(f"\nðŸ“ Memory Updates:")
        for update in recs['memory_updates']:
            print(f"  â€¢ {update['action'].upper()}: {update['target']}")
    
    if recs.get('new_abstractions'):
        print(f"\nðŸŽ¯ Suggested Abstractions:")
        for abst in recs['new_abstractions']:
            print(f"  â€¢ {abst['pattern']} (used {abst['usage_count']} times)")
            print(f"    â†’ Create: {abst['suggested_file']}")
    
    if recs.get('cross_project_suggestions'):
        print(f"\nðŸ”— Cross-Project Opportunities:")
        for suggestion in recs['cross_project_suggestions']:
            projects = ", ".join(suggestion['projects'])
            print(f"  â€¢ Share '{suggestion['pattern']}' with: {projects}")
            print(f"    Reason: {suggestion['reason']}")
    
    # Novel insights
    insights = analysis.get('novel_insights', [])
    if insights:
        print(f"\nðŸ’¡ Novel Insights:")
        for insight in insights:
            print(f"  â€¢ {insight}")
    
    print(f"\nðŸ“Œ Summary: {report.get('summary', 'Analysis complete')}")

def prompt_ai_analysis():
    """Prompt the current AI to provide additional analysis"""
    print("\nðŸ¤– AI Analysis Request")
    print("=" * 50)
    print("""
Based on the ReAct analysis above, please provide:

1. **Pattern Insights**: What architectural patterns or coding practices are emerging?
2. **Memory Strategy**: How should we organize this knowledge for future reference?
3. **Action Items**: What specific refactoring or abstractions would provide most value?
4. **Cross-Project**: Which patterns would benefit other projects and how?

Please use ReAct thinking:
- THINK: Analyze the patterns and their implications
- ACT: Suggest specific memory operations
- DECIDE: Recommend the optimal knowledge storage strategy
""")

def main():
    """Main entry point for /save-react"""
    print("ðŸš€ /save-react - Experimental ReAct-Enhanced Save")
    print("=" * 50)
    
    # Get current session
    session_file = get_current_session()
    if not session_file:
        return
    
    try:
        # Run ReAct analysis
        report = run_react_analysis(session_file)
        
        # Display recommendations
        display_recommendations(report)
        
        # Always prompt for AI analysis
        prompt_ai_analysis()
        
        print("\n" + "="*50)
        print("ðŸ’­ Please provide your ReAct analysis above.")
        print("ðŸ“ Then you can run /save to complete the regular save process.")
        
    except Exception as e:
        print(f"\nâŒ Error during ReAct analysis: {e}")
        print("You can still run regular /save if needed.")

if __name__ == "__main__":
    main()

PYTHON_SCRIPT
